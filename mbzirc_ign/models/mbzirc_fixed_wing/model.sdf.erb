<%
if !defined?(name) || name== nil || name.empty?
  $model_name = 'mbzirc_quadrotor'
else
  $model_name = name
end
%>

<?xml version="1.0"?>
<sdf version='1.9'>
  <model name="<%= $model_name%>">

    <!-- Platform base model-->
    <include merge="true">
      <uri>model://mbzirc_fixed_wing_base</uri>
    </include>

    <!-- Joints -->
    <plugin
      filename="ignition-gazebo-joint-position-controller-system"
      name="ignition::gazebo::systems::JointPositionController">
      <joint_name>flap_left_joint</joint_name>
      <use_velocity_commands>true</use_velocity_commands>
      <topic>/model/<%= $model_name%>/joint/left_flap_joint/cmd_pos</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-position-controller-system"
      name="ignition::gazebo::systems::JointPositionController">
      <joint_name>flap_right_joint</joint_name>
      <use_velocity_commands>true</use_velocity_commands>
      <topic>/model/<%= $model_name%>/joint/right_flap_joint/cmd_pos</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-controller-system"
      name="ignition::gazebo::systems::JointController">
      <joint_name>propeller_joint</joint_name>
    </plugin>

    <plugin filename="libFixedWingController.so"
      name="mbzirc::FixedWingControllerPlugin">
      <model_name><%= $model_name%></model_name>
      <cmd_topic>/<%= $model_name%>/cmd/attitude</cmd_topic>
      <link_name>wing</link_name>
      <roll_axis>0 1 0</roll_axis>
      <roll_p>0.1</roll_p>
      <roll_i>0.01</roll_i>
      <roll_d>0.01</roll_d>
      <pitch_axis>1 0 0</pitch_axis>
      <pitch_p>1</pitch_p>
      <pitch_i>0.2</pitch_i>
      <pitch_d>0.1</pitch_d>
      <left_flap>/model/<%= $model_name%>/joint/left_flap_joint/cmd_pos</left_flap>
      <right_flap>/model/<%= $model_name%>/joint/right_flap_joint/cmd_pos</right_flap>
      <propeller>/model/<%= $model_name%>/joint/propeller_joint/cmd_vel</propeller>
    </plugin>

    <!-- Battery plugin -->
    <!-- Since we are interested in using time as the limiting factor -->
    <plugin filename="libignition-gazebo-linearbatteryplugin-system.so"
      name="ignition::gazebo::systems::LinearBatteryPlugin">
      <battery_name>linear_battery</battery_name>
      <voltage>12.694</voltage>
      <open_circuit_voltage_constant_coef>12.694</open_circuit_voltage_constant_coef>
      <open_circuit_voltage_linear_coef>0</open_circuit_voltage_linear_coef>
      <initial_charge><%= capacity%></initial_charge>
      <capacity><%= capacity%></capacity>
      <resistance>0.061523</resistance>
      <smooth_current_tau>1.9499</smooth_current_tau>
      <power_load>6.6</power_load>
      <start_on_motion>true</start_on_motion>
      <fix_issue_225>true</fix_issue_225>
    </plugin>
  </model>
</sdf>
